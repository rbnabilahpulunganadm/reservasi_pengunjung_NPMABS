<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservasi - Klinik Nabilah Pulungan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #FDF2F8; /* Soft Pink Background */
        }
        .font-mplus {
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        .main-container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }
        .navbar {
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-item.active svg, .nav-item.active span {
            color: #DB2777; /* Pink-700 */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 5px;
        }
        ::-webkit-scrollbar-track {
            background: #FDF2F8;
        }
        ::-webkit-scrollbar-thumb {
            background: #F472B6; /* Pink-400 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #DB2777; /* Pink-700 */
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .form-input, .form-select, .form-textarea {
            border-width: 1px;
            border-color: #FBCFE8; /* Pink-200 */
            transition: all 0.3s ease;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: #DB2777; /* Pink-700 */
            box-shadow: 0 0 0 2px #FCE7F3; /* Pink-100 */
        }
        .btn-primary {
            background-color: #EC4899; /* Pink-500 */
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #DB2777; /* Pink-700 */
        }
        .btn-secondary {
            background-color: #FCE7F3; /* Pink-100 */
            color: #DB2777; /* Pink-700 */
        }
        /* Animation for loading button */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin: -10px 0 0 -10px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Style for the ticket to be generated as image */
        #ticket-content {
            background: url('data:image/svg+xml;utf8,<svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="p" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M50 0 L100 25 L50 50 L0 25 Z M0 50 L50 75 L0 100 L-50 75 Z M100 50 L150 75 L100 100 L50 75 Z" fill="%23FCE7F3" /></pattern></defs><rect width="100%" height="100%" fill="white"/><rect width="100%" height="100%" fill="url(%23p)"/></svg>'), white;
        }
        .medical-input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
    </style>
</head>
<body class="bg-pink-50">

<div id="app-container" class="main-container relative pb-20">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="hidden fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-pink-500"></div>
    </div>
    
    <!-- Modal for Therapist Name and Medical Data -->
    <div id="therapist-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-pink-800 mb-4">Selesaikan Treatment</h3>
            <p class="text-gray-600 mb-4">Masukkan data terapis dan pemeriksaan medis.</p>
            
            <div class="mb-4">
                <label for="therapist-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Terapis *</label>
                <input type="text" id="therapist-name" placeholder="Nama Terapis" class="w-full p-3 rounded-lg form-input" required>
            </div>
            
            <div class="mb-4">
                <label for="additional-treatment" class="block text-sm font-medium text-gray-700 mb-1">Treatment Tambahan (jika ada)</label>
                <input type="text" id="additional-treatment" placeholder="Treatment Tambahan" class="w-full p-3 rounded-lg form-input">
            </div>
            
            <div class="mb-4">
                <label for="treatment-fee" class="block text-sm font-medium text-gray-700 mb-1">Tarif Treatment (Rp)</label>
                <input type="number" id="treatment-fee" placeholder="Tarif Treatment" class="w-full p-3 rounded-lg form-input">
            </div>
            
            <h4 class="font-bold text-lg text-pink-700 border-b-2 border-pink-200 pb-2 mt-6 mb-4">Pemeriksaan Medis</h4>
            
            <div class="medical-input-grid mb-4">
                <div>
                    <label for="medical-temperature" class="block text-sm font-medium text-gray-700 mb-1">Suhu Tubuh (Â°C)</label>
                    <input type="number" id="medical-temperature" step="0.1" min="35" max="42" placeholder="36.5" class="w-full p-3 rounded-lg form-input">
                </div>
                <div>
                    <label for="medical-weight" class="block text-sm font-medium text-gray-700 mb-1">Berat Badan (kg)</label>
                    <input type="number" id="medical-weight" step="0.1" min="0" placeholder="55.5" class="w-full p-3 rounded-lg form-input">
                </div>
            </div>
            
            <div class="medical-input-grid mb-4">
                <div>
                    <label for="medical-height" class="block text-sm font-medium text-gray-700 mb-1">Tinggi Badan (cm)</label>
                    <input type="number" id="medical-height" step="0.1" min="0" placeholder="165" class="w-full p-3 rounded-lg form-input">
                </div>
                <div>
                    <label for="medical-bmi" class="block text-sm font-medium text-gray-700 mb-1">BMI</label>
                    <input type="text" id="medical-bmi" readonly class="w-full p-3 rounded-lg form-input bg-gray-100">
                </div>
            </div>
            
            <div class="mb-4">
                <label for="medical-allergy" class="block text-sm font-medium text-gray-700 mb-1">Riwayat Alergi</label>
                <input type="text" id="medical-allergy" placeholder="Riwayat alergi (jika ada)" class="w-full p-3 rounded-lg form-input">
            </div>
            
            <div class="mb-4">
                <label for="medical-blood-pressure" class="block text-sm font-medium text-gray-700 mb-1">Tekanan Darah</label>
                <input type="text" id="medical-blood-pressure" placeholder="120/80 mmHg" class="w-full p-3 rounded-lg form-input">
            </div>
            
            <div class="mb-4">
                <label for="medical-notes" class="block text-sm font-medium text-gray-700 mb-1">Catatan Medis Lainnya</label>
                <textarea id="medical-notes" rows="2" placeholder="Catatan medis tambahan" class="w-full p-3 rounded-lg form-textarea"></textarea>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="hideTherapistModal()" class="py-2 px-4 rounded-lg btn-secondary font-semibold">Batal</button>
                <button onclick="completeTreatment()" class="py-2 px-4 rounded-lg btn-primary font-semibold">Selesaikan</button>
            </div>
        </div>
    </div>

    <!-- Modal for Queue Ticket -->
    <div id="ticket-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-2xl font-bold text-center text-pink-800 mb-2 font-mplus">Reservasi Berhasil!</h3>
            <p class="text-center text-gray-500 mb-4">Silakan simpan nomor antrian ini.</p>
            <div id="ticket-content" class="border-2 border-dashed border-pink-300 rounded-xl p-4 mb-4">
                <div class="text-center">
                    <h4 class="font-mplus text-pink-700 font-bold text-lg">Klinik Nabilah Pulungan</h4>
                    <p class="text-xs text-pink-500">Bukti Reservasi Treatment</p>
                </div>
                <div id="ticket-qrcode" class="flex justify-center my-3"></div>
                <p class="text-center text-sm text-gray-700 mb-2">No. RME: <span id="ticket-rme" class="font-bold"></span></p>
                <div class="border-t border-b border-pink-200 py-2 my-2 text-sm">
                    <p><strong>Nama:</strong> <span id="ticket-name"></span></p>
                    <p><strong>Treatment:</strong> <span id="ticket-treatment"></span></p>
                    <p><strong>Jadwal:</strong> <span id="ticket-schedule"></span></p>
                </div>
                <div id="ticket-medical-data" class="text-xs mt-2 hidden">
                    <h5 class="font-semibold text-pink-700">Pemeriksaan Medis:</h5>
                    <div id="ticket-medical-details"></div>
                </div>
                <div id="ticket-medical-history" class="text-xs mt-2"></div>
                <p class="text-center font-bold text-4xl text-pink-600 font-mplus mt-2" id="ticket-queue-number"></p>
                <p class="text-center text-xs text-gray-400 mt-2">Terima kasih atas kunjungan Anda!</p>
            </div>
            <div class="flex flex-col gap-3">
                <button onclick="downloadTicket()" class="w-full py-3 px-4 rounded-lg btn-primary font-semibold flex items-center justify-center gap-2"><i class="fas fa-download"></i> Unduh Nomor Antrian (Gambar)</button>
                <button onclick="printTicketPDF()" class="w-full py-3 px-4 rounded-lg bg-blue-500 text-white font-semibold flex items-center justify-center gap-2"><i class="fas fa-file-pdf"></i> Cetak PDF</button>
                <button onclick="hideTicketModal()" class="w-full py-3 px-4 rounded-lg btn-secondary font-semibold">Tutup</button>
            </div>
        </div>
    </div>

    <!-- PAGES -->
    <main class="p-4 sm:p-6">
        <!-- PAGE 1: FORM RESERVASI -->
        <div id="page-form" class="page active">
            <header class="text-center mb-6">
                <h1 class="text-3xl font-bold text-pink-800 font-mplus">Reservasi Treatment</h1>
                <p class="text-gray-500">Isi data untuk jadwal treatment Anda.</p>
            </header>
            
            <div class="mb-4">
                 <div class="relative">
                    <input type="text" id="search-customer" placeholder="Cari Pelanggan (Nama/HP/IG/RME)" class="w-full p-3 pl-10 rounded-lg form-input">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div id="search-results" class="bg-white border border-pink-200 rounded-lg mt-1 max-h-40 overflow-y-auto"></div>
            </div>

            <form id="reservation-form" class="space-y-4">
                <h3 class="font-bold text-lg text-pink-700 border-b-2 border-pink-200 pb-2">Data Pemesan</h3>
                <input type="hidden" id="rme">
                <div>
                    <label for="booker-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Pemesan</label>
                    <input type="text" id="booker-name" class="w-full p-3 rounded-lg form-input" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">No. Telepon/WA</label>
                        <input type="tel" id="phone" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                    <div>
                        <label for="instagram" class="block text-sm font-medium text-gray-700 mb-1">Instagram</label>
                        <input type="text" id="instagram" class="w-full p-3 rounded-lg form-input">
                    </div>
                </div>
                <div>
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Alamat Domisili</label>
                    <textarea id="address" rows="2" class="w-full p-3 rounded-lg form-textarea"></textarea>
                </div>
                
                <h3 class="font-bold text-lg text-pink-700 border-b-2 border-pink-200 pb-2 pt-4">Data Pasien</h3>
                <div>
                    <label for="patient-name" class="block text-sm font-medium text-gray-700 mb-1">Nama (yang ingin treatment)</label>
                    <input type="text" id="patient-name" class="w-full p-3 rounded-lg form-input" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="dob" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Lahir</label>
                        <input type="date" id="dob" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                    <div>
                        <label for="age" class="block text-sm font-medium text-gray-700 mb-1">Usia (Tahun, Bulan, Minggu, Hari)</label>
                        <input type="text" id="age" class="w-full p-3 rounded-lg form-input bg-pink-50" readonly>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kelamin</label>
                    <div class="flex gap-4">
                        <label class="flex items-center"><input type="radio" name="gender" value="Perempuan" class="mr-2 text-pink-500 focus:ring-pink-500" checked> Perempuan</label>
                        <label class="flex items-center"><input type="radio" name="gender" value="Laki-laki" class="mr-2 text-pink-500 focus:ring-pink-500"> Laki-laki</label>
                    </div>
                </div>

                <h3 class="font-bold text-lg text-pink-700 border-b-2 border-pink-200 pb-2 pt-4">Detail Treatment</h3>
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Kategori Treatment</label>
                    <select id="category" class="w-full p-3 rounded-lg form-select">
                        <option>Baby/Kid Spa</option>
                        <option>Ladies Spa</option>
                        <option>Mom/Bumil/Nifas Spa</option>
                        <option>Tindik dr Evoo</option>
                        <option>ANC/Senam</option>
                        <option>Umum</option>
                        <option>Partus/Melahirkan</option>
                        <option>Homecare</option>
                        <option value="other">Lainnya...</option>
                    </select>
                    <input type="text" id="category-other" class="hidden w-full p-3 mt-2 rounded-lg form-input" placeholder="Ketik kategori lainnya">
                </div>

                <div id="treatments-container">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Treatment/Spa 1</label>
                        <input type="text" name="treatment" class="w-full p-3 rounded-lg form-input" placeholder="Nama paket treatment" required>
                    </div>
                </div>
                <button type="button" onclick="addTreatmentField()" class="text-sm text-pink-600 font-semibold hover:underline">+ Tambah Treatment Lain</button>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ada Keluhan?</label>
                    <div class="flex gap-4">
                        <label class="flex items-center"><input type="radio" name="complaint_toggle" value="ya" class="mr-2 text-pink-500 focus:ring-pink-500"> Ya</label>
                        <label class="flex items-center"><input type="radio" name="complaint_toggle" value="tidak" class="mr-2 text-pink-500 focus:ring-pink-500" checked> Tidak</label>
                    </div>
                    <textarea id="complaint-text" rows="2" class="hidden w-full p-3 mt-2 rounded-lg form-textarea" placeholder="Sebutkan keluhan Anda"></textarea>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="booking-date" class="block text-sm font-medium text-gray-700 mb-1">Rencana Datang (Tanggal)</label>
                        <input type="date" id="booking-date" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                    <div>
                        <label for="booking-time" class="block text-sm font-medium text-gray-700 mb-1">Jam</label>
                        <select id="booking-time" class="w-full p-3 rounded-lg form-select" required>
                            <!-- Jam akan diisi oleh JavaScript -->
                        </select>
                    </div>
                </div>

                <button type="submit" class="w-full mt-6 py-4 rounded-xl btn-primary font-bold text-lg shadow-lg shadow-pink-500/30">
                    <i class="fas fa-calendar-check mr-2"></i> Buat Reservasi
                </button>
            </form>
        </div>

        <!-- PAGE 2: DAFTAR RESERVASI -->
        <div id="page-list" class="page">
            <header class="mb-6">
                <h1 class="text-3xl font-bold text-pink-800 font-mplus">Daftar Reservasi</h1>
                
                <div class="flex flex-wrap gap-2 mb-4">
                    <select id="filter-status" class="p-2 rounded-lg form-select flex-1 min-w-[120px]" onchange="renderReservationList()">
                        <option value="all">Semua Status</option>
                        <option value="Dalam Antrian">Dalam Antrian</option>
                        <option value="Sedang Treatment">Sedang Treatment</option>
                        <option value="Selesai">Selesai</option>
                    </select>
                    
                    <select id="sort-by" class="p-2 rounded-lg form-select flex-1 min-w-[120px]" onchange="renderReservationList()">
                        <option value="timestamp-desc">Terbaru</option>
                        <option value="timestamp-asc">Terlama</option>
                        <option value="name-asc">Nama A-Z</option>
                        <option value="name-desc">Nama Z-A</option>
                    </select>
                </div>
                
                <div class="relative">
                    <input type="text" id="search-reservations" placeholder="Cari di daftar reservasi..." class="w-full p-3 pl-10 rounded-lg form-input" oninput="renderReservationList()">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
            </header>
            <div id="reservation-list" class="space-y-4">
                <!-- Daftar reservasi akan ditampilkan di sini -->
                 <p class="text-center text-gray-500 mt-10">Belum ada reservasi.</p>
            </div>
        </div>

        <!-- PAGE 3: LAPORAN STATISTIK -->
        <div id="page-stats" class="page">
            <header class="mb-6">
                <h1 class="text-3xl font-bold text-pink-800 font-mplus">Laporan Statistik</h1>
                <p class="text-gray-500">Pantau performa klinik Anda.</p>
            </header>
            <div class="flex justify-center gap-2 mb-6">
                <button onclick="generateStats('today')" class="stat-button flex-1 py-2 px-3 bg-pink-100 text-pink-700 rounded-lg font-semibold">Hari Ini</button>
                <button onclick="generateStats('week')" class="stat-button flex-1 py-2 px-3 bg-pink-100 text-pink-700 rounded-lg font-semibold">Pekan Ini</button>
                <button onclick="generateStats('month')" class="stat-button flex-1 py-2 px-3 bg-pink-100 text-pink-700 rounded-lg font-semibold">Bulan Ini</button>
            </div>
             
            <div id="stats-content" class="space-y-4">
                <!-- Statistik akan ditampilkan di sini -->
            </div>
            
            <div class="mt-6">
                <button onclick="exportToPDF()" class="w-full py-3 px-4 rounded-lg btn-primary font-semibold flex items-center justify-center gap-2">
                    <i class="fas fa-file-pdf"></i> Export Laporan ke PDF
                </button>
            </div>
        </div>
        
        <!-- PAGE 4: PANDUAN -->
        <div id="page-guide" class="page">
             <header class="mb-6">
                <h1 class="text-3xl font-bold text-pink-800 font-mplus">Panduan Aplikasi</h1>
                <p class="text-gray-500">Cara menggunakan aplikasi reservasi.</p>
            </header>
            <div class="space-y-6 text-gray-700">
                <div>
                    <h3 class="font-bold text-lg text-pink-600 flex items-center gap-2"><i class="fas fa-plus-circle"></i>Membuat Reservasi Baru</h3>
                    <p class="mt-1 ml-6">Gunakan tab 'Reservasi Baru'. Isi semua data yang diperlukan. Jika pelanggan sudah pernah datang, gunakan fitur 'Cari Pelanggan' di bagian atas untuk mengisi data secara otomatis.</p>
                </div>
                 <div>
                    <h3 class="font-bold text-lg text-pink-600 flex items-center gap-2"><i class="fas fa-list-alt"></i>Melihat Daftar Reservasi</h3>
                    <p class="mt-1 ml-6">Buka tab 'Daftar'. Di sini Anda bisa melihat semua reservasi yang masuk. Gunakan filter dan pencarian untuk menemukan reservasi spesifik.</p>
                </div>
                 <div>
                    <h3 class="font-bold text-lg text-pink-600 flex items-center gap-2"><i class="fas fa-tasks"></i>Mengubah Status Treatment</h3>
                    <p class="mt-1 ml-6">Di tab 'Daftar', setiap kartu reservasi memiliki tombol aksi. Klik 'Mulai Treatment' saat pasien mulai dilayani. Setelah selesai, klik 'Selesaikan', isi data terapis dan pemeriksaan medis, dan status akan berubah menjadi 'Selesai'.</p>
                </div>
                 <div>
                    <h3 class="font-bold text-lg text-pink-600 flex items-center gap-2"><i class="fas fa-chart-pie"></i>Melihat Laporan</h3>
                    <p class="mt-1 ml-6">Tab 'Laporan' menyajikan data statistik kunjungan. Pilih periode (hari ini, pekan ini, bulan ini) untuk melihat ringkasan data yang informatif.</p>
                </div>
                 <div>
                    <h3 class="font-bold text-lg text-pink-600 flex items-center gap-2"><i class="fas fa-download"></i>Mencetak Nomor Antrian</h3>
                    <p class="mt-1 ml-6">Setelah reservasi berhasil dibuat, akan muncul pop-up nomor antrian. Klik tombol 'Unduh Nomor Antrian' untuk menyimpannya sebagai gambar/foto di perangkat Anda, atau 'Cetak PDF' untuk format dokumen.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- BOTTOM NAVIGATION -->
    <nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-[500px] bg-white/80 backdrop-blur-sm border-t border-pink-100 flex justify-around navbar">
        <button onclick="showPage('page-form')" class="nav-item flex-1 py-3 text-center text-gray-500 hover:text-pink-600 transition-colors active">
            <i class="fas fa-plus-circle text-2xl"></i>
            <span class="block text-xs font-medium">Reservasi Baru</span>
        </button>
        <button onclick="showPage('page-list')" class="nav-item flex-1 py-3 text-center text-gray-500 hover:text-pink-600 transition-colors">
            <i class="fas fa-list-alt text-2xl"></i>
            <span class="block text-xs font-medium">Daftar</span>
        </button>
        <button onclick="showPage('page-stats')" class="nav-item flex-1 py-3 text-center text-gray-500 hover:text-pink-600 transition-colors">
            <i class="fas fa-chart-pie text-2xl"></i>
            <span class="block text-xs font-medium">Laporan</span>
        </button>
        <button onclick="showPage('page-guide')" class="nav-item flex-1 py-3 text-center text-gray-500 hover:text-pink-600 transition-colors">
            <i class="fas fa-book text-2xl"></i>
            <span class="block text-xs font-medium">Panduan</span>
        </button>
    </nav>
</div>

<script>
// --- KONFIGURASI ---
// Ganti dengan URL Web App Google Apps Script Anda setelah dideploy
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzsX_LQbBOzVDtIHwL5LVzSQ2lAY9H5JyuwRtREhTOjcfUACeuvZw5zhmpuMCTc-Sn2aA/exec'; 

// --- STATE APLIKASI ---
let reservations = [];
let customers = []; // Untuk menyimpan data pelanggan unik
let treatmentCounter = 1;
let currentlyEditingReservationId = null;
let loadingButtons = {}; // Untuk melacak tombol yang sedang loading

// --- DOM ELEMENTS ---
const dobInput = document.getElementById('dob');
const ageInput = document.getElementById('age');
const categorySelect = document.getElementById('category');
const categoryOtherInput = document.getElementById('category-other');
const complaintToggle = document.querySelectorAll('input[name="complaint_toggle"]');
const complaintText = document.getElementById('complaint-text');
const reservationForm = document.getElementById('reservation-form');
const bookingDateInput = document.getElementById('booking-date');
const bookingTimeSelect = document.getElementById('booking-time');
const searchCustomerInput = document.getElementById('search-customer');
const searchResultsContainer = document.getElementById('search-results');
const searchReservationsInput = document.getElementById('search-reservations');
const filterStatusSelect = document.getElementById('filter-status');
const sortBySelect = document.getElementById('sort-by');

// Elemen input medis
const medicalTemperature = document.getElementById('medical-temperature');
const medicalWeight = document.getElementById('medical-weight');
const medicalHeight = document.getElementById('medical-height');
const medicalBmi = document.getElementById('medical-bmi');
const medicalAllergy = document.getElementById('medical-allergy');
const medicalBloodPressure = document.getElementById('medical-blood-pressure');
const medicalNotes = document.getElementById('medical-notes');

// --- FUNGSI UTAMA ---
document.addEventListener('DOMContentLoaded', () => {
    // Inisialisasi: set tanggal minimum dan isi opsi jam
    const today = new Date().toISOString().split('T')[0];
    dobInput.max = today;
    bookingDateInput.min = today;
    bookingDateInput.value = today;
    
    showPage('page-form');

    // Event Listeners
    dobInput.addEventListener('change', calculateAge);
    categorySelect.addEventListener('change', handleCategoryChange);
    complaintToggle.forEach(radio => radio.addEventListener('change', handleComplaintToggle));
    reservationForm.addEventListener('submit', handleFormSubmit);
    bookingDateInput.addEventListener('change', populateTimeSlots);
    searchCustomerInput.addEventListener('input', handleCustomerSearch);
    
    // Event listeners untuk kalkulasi BMI otomatis
    medicalWeight.addEventListener('input', calculateBMI);
    medicalHeight.addEventListener('input', calculateBMI);
    
    // Panggil fungsi untuk mengambil data dan mengisi timeslots
    fetchInitialData();
    populateTimeSlots();
});

// FUNGSI UNTUK MENGAMBIL DATA DARI GOOGLE SHEET
async function fetchInitialData() {
    showLoading();
    if (GOOGLE_SCRIPT_URL === 'MASUKKAN_URL_SCRIPT_ANDA_DI_SINI') {
        console.warn("URL Google Script belum diatur. Mode Offline.");
        hideLoading();
        // Inisialisasi tampilan awal jika offline
        populateTimeSlots();
        renderReservationList();
        return;
    }

    try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getData`);
        const data = await response.json();

        if (data && data.reservations && data.customers) {
            // Ubah format tanggal agar konsisten jika perlu (Apps Script kadang mengembalikan format lengkap)
            reservations = data.reservations.map(r => ({
                ...r,
                // Pastikan nama properti sesuai dengan header di Google Sheet
                id: r.ID,
                timestamp: r.Timestamp, 
                rme: r.RME,
                bookerName: r['Nama Pemesan'],
                phone: r.Telepon,
                instagram: r.Instagram,
                address: r.Alamat,
                patientName: r['Nama Pasien'],
                dob: r['Tgl Lahir'],
                age: r.Usia,
                gender: r.Gender,
                category: r.Kategori,
                treatments: r.Treatments,
                hasComplaint: r['Ada Keluhan'],
                complaintText: r['Detail Keluhan'],
                bookingDate: new Date(r['Tgl Booking']).toISOString().split('T')[0],
                bookingTime: r['Jam Booking'],
                status: r.Status,
                therapist: r.Terapis,
                additionalTreatment: r.TreatmentTambahan || '',
                fee: r.Tarif || '',
                // Data medis baru
                temperature: r.Suhu || '',
                weight: r.Berat || '',
                height: r.Tinggi || '',
                bmi: r.BMI || '',
                allergy: r.Alergi || '',
                bloodPressure: r['Tekanan Darah'] || '',
                medicalNotes: r['Catatan Medis'] || ''
            }));
            
            // Konversi nama properti dari header sheet ke camelCase yang dipakai di JS
            customers = data.customers.map(c => ({
                rme: c.RME,
                patientName: c['Nama Pasien'],
                bookerName: c['Nama Pemesan'],
                phone: c.Telepon,
                instagram: c.Instagram,
                address: c.Alamat,
                dob: new Date(c['Tgl Lahir']).toISOString().split('T')[0],
                gender: c.Gender
            }));
            
            console.log("Data berhasil diambil:", { reservations, customers });
        }
    } catch (error) {
        console.error("Gagal mengambil data dari Google Sheet:", error);
        alert("Tidak dapat memuat data dari server. Aplikasi mungkin berjalan dalam mode offline.");
    } finally {
        // Setelah data diambil (atau gagal), baru render tampilan
        populateTimeSlots();
        renderReservationList();
        hideLoading();
    }
}

function showPage(pageId) {
    // Sembunyikan semua halaman
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    
    // Tampilkan halaman yang dipilih
    document.getElementById(pageId).classList.add('active');
    
    // Update navigasi aktif
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Tentukan tombol navigasi mana yang aktif
    let navButton;
    switch(pageId) {
        case 'page-form':
            navButton = document.querySelector('.nav-item:nth-child(1)');
            break;
        case 'page-list':
            navButton = document.querySelector('.nav-item:nth-child(2)');
            break;
        case 'page-stats':
            navButton = document.querySelector('.nav-item:nth-child(3)');
            break;
        case 'page-guide':
            navButton = document.querySelector('.nav-item:nth-child(4)');
            break;
    }
    
    if (navButton) {
        navButton.classList.add('active');
    }
}

function calculateAge() {
    const dob = new Date(dobInput.value);
    const today = new Date();
    
    if (isNaN(dob.getTime())) return;
    
    let years = today.getFullYear() - dob.getFullYear();
    let months = today.getMonth() - dob.getMonth();
    let days = today.getDate() - dob.getDate();
    
    // Koreksi jika hari lahir belum lewat di bulan ini
    if (days < 0) {
        months--;
        // Hitung jumlah hari di bulan sebelumnya
        const lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
        days += lastMonth.getDate();
    }
    
    // Koreksi jika bulan lahir belum lewat di tahun ini
    if (months < 0) {
        years--;
        months += 12;
    }
    
    // Hitung usia dalam minggu (untuk bayi)
    const diffTime = Math.abs(today - dob);
    const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
    
    let ageText = '';
    if (years > 0) {
        ageText = `${years} Tahun`;
        if (months > 0) ageText += `, ${months} Bulan`;
    } else if (months > 0) {
        ageText = `${months} Bulan`;
        if (diffWeeks % 4 > 0) ageText += `, ${Math.floor(diffWeeks % 4)} Minggu`;
    } else {
        ageText = `${diffWeeks} Minggu`;
        if (days % 7 > 0) ageText += `, ${days % 7} Hari`;
    }
    
    ageInput.value = ageText;
}

function handleCategoryChange() {
    if (categorySelect.value === 'other') {
        categoryOtherInput.classList.remove('hidden');
        categoryOtherInput.required = true;
    } else {
        categoryOtherInput.classList.add('hidden');
        categoryOtherInput.required = false;
    }
}

function handleComplaintToggle() {
    const hasComplaint = document.querySelector('input[name="complaint_toggle"]:checked').value === 'ya';
    complaintText.classList.toggle('hidden', !hasComplaint);
    complaintText.required = hasComplaint;
}

function addTreatmentField() {
    treatmentCounter++;
    const newField = document.createElement('div');
    newField.innerHTML = `
        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Treatment/Spa ${treatmentCounter}</label>
        <input type="text" name="treatment" class="w-full p-3 rounded-lg form-input" placeholder="Nama paket treatment">
    `;
    document.getElementById('treatments-container').appendChild(newField);
}

function populateTimeSlots() {
    // Kosongkan dropdown waktu
    bookingTimeSelect.innerHTML = '';
    
    // Jika tanggal tidak dipilih, keluar dari fungsi
    if (!bookingDateInput.value) return;
    
    // Waktu operasional klinik (contoh: 08:00 - 17:00)
    const startHour = 8;
    const endHour = 17;
    const slotDuration = 60; // menit
    
    // Buat opsi jam berdasarkan waktu operasional
    for (let hour = startHour; hour <= endHour; hour++) {
        for (let minute = 0; minute < 60; minute += slotDuration) {
            const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            
            // Hitung kuota yang tersedia untuk jam ini
            const selectedDate = bookingDateInput.value;
            const reservedCount = reservations.filter(r => 
                r.bookingDate === selectedDate && 
                r.bookingTime === timeString && 
                r.status !== 'Batal'
            ).length;
            
            // Kuota maksimal per jam (misalnya 3 pasien per jam)
            const maxQuota = 3;
            const availableSlots = maxQuota - reservedCount;
            
            // Tambahkan ke dropdown hanya jika masih ada kuota
            if (availableSlots > 0) {
                const option = document.createElement('option');
                option.value = timeString;
                option.textContent = `${timeString} (${availableSlots} slot tersedia)`;
                option.disabled = availableSlots <= 0;
                bookingTimeSelect.appendChild(option);
            }
        }
    }
    
    // Jika tidak ada slot tersedia sama sekali
    if (bookingTimeSelect.options.length === 0) {
        const option = document.createElement('option');
        option.textContent = 'Tidak ada slot tersedia';
        option.disabled = true;
        bookingTimeSelect.appendChild(option);
    }
}

function handleCustomerSearch() {
    const query = searchCustomerInput.value.toLowerCase().trim();
    
    // Kosongkan hasil pencarian jika query kosong
    if (!query) {
        searchResultsContainer.innerHTML = '';
        searchResultsContainer.classList.add('hidden');
        return;
    }
    
    // Filter pelanggan berdasarkan query
    const results = customers.filter(customer => 
        customer.patientName.toLowerCase().includes(query) ||
        customer.bookerName.toLowerCase().includes(query) ||
        customer.phone.includes(query) ||
        (customer.instagram && customer.instagram.toLowerCase().includes(query)) ||
        (customer.rme && customer.rme.toLowerCase().includes(query))
    );
    
    // Tampilkan hasil
    searchResultsContainer.innerHTML = '';
    
    if (results.length === 0) {
        const noResult = document.createElement('div');
        noResult.className = 'p-3 text-gray-500 text-center';
        noResult.textContent = 'Tidak ditemukan pelanggan';
        searchResultsContainer.appendChild(noResult);
    } else {
        results.forEach(customer => {
            const resultItem = document.createElement('div');
            resultItem.className = 'p-3 border-b border-pink-100 hover:bg-pink-50 cursor-pointer';
            resultItem.innerHTML = `
                <div class="font-semibold">${customer.patientName}</div>
                <div class="text-sm text-gray-600">${customer.phone} | ${customer.rme || 'No RME'}</div>
            `;
            resultItem.addEventListener('click', () => {
                fillCustomerData(customer);
                searchResultsContainer.innerHTML = '';
                searchResultsContainer.classList.add('hidden');
            });
            searchResultsContainer.appendChild(resultItem);
        });
    }
    
    searchResultsContainer.classList.remove('hidden');
}

function fillCustomerData(customer) {
    document.getElementById('rme').value = customer.rme || '';
    document.getElementById('booker-name').value = customer.bookerName;
    document.getElementById('phone').value = customer.phone;
    document.getElementById('instagram').value = customer.instagram || '';
    document.getElementById('address').value = customer.address || '';
    document.getElementById('patient-name').value = customer.patientName;
    document.getElementById('dob').value = customer.dob;
    calculateAge(); // Hitung ulang usia berdasarkan DOB
    
    // Set jenis kelamin
    const genderRadios = document.getElementsByName('gender');
    for (const radio of genderRadios) {
        if (radio.value === customer.gender) {
            radio.checked = true;
            break;
        }
    }
}

async function handleFormSubmit(e) {
    e.preventDefault();
    
    // Validasi form
    if (!validateForm()) return;
    
    // Tampilkan loading pada tombol submit
    const submitButton = e.target.querySelector('button[type="submit"]');
    setButtonLoading(submitButton, true);
    
    try {
        // Kumpulkan data dari form
        const formData = {
            rme: document.getElementById('rme').value,
            bookerName: document.getElementById('booker-name').value,
            phone: document.getElementById('phone').value,
            instagram: document.getElementById('instagram').value,
            address: document.getElementById('address').value,
            patientName: document.getElementById('patient-name').value,
            dob: document.getElementById('dob').value,
            age: document.getElementById('age').value,
            gender: document.querySelector('input[name="gender"]:checked').value,
            category: categorySelect.value === 'other' ? categoryOtherInput.value : categorySelect.value,
            treatments: Array.from(document.querySelectorAll('input[name="treatment"]')).map(input => input.value).filter(Boolean),
            hasComplaint: document.querySelector('input[name="complaint_toggle"]:checked').value,
            complaintText: document.getElementById('complaint-text').value,
            bookingDate: document.getElementById('booking-date').value,
            bookingTime: document.getElementById('booking-time').value,
            status: 'Dalam Antrian'
        };
        
        // Kirim data ke Google Sheet
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'createReservation',
                data: formData
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Reset form
            reservationForm.reset();
            treatmentCounter = 1;
            document.getElementById('treatments-container').innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Treatment/Spa 1</label>
                    <input type="text" name="treatment" class="w-full p-3 rounded-lg form-input" placeholder="Nama paket treatment" required>
                </div>
            `;
            
            // Refresh data dan tampilkan tiket
            await fetchInitialData();
            showTicketModal(result.reservationId);
        } else {
            alert('Gagal membuat reservasi: ' + (result.message || 'Terjadi kesalahan'));
        }
    } catch (error) {
        console.error('Error submitting form:', error);
        alert('Terjadi kesalahan saat mengirim data. Silakan coba lagi.');
    } finally {
        setButtonLoading(submitButton, false);
    }
}

function validateForm() {
    // Validasi sederhana - pastikan semua field required terisi
    const requiredFields = reservationForm.querySelectorAll('[required]');
    let isValid = true;
    
    for (const field of requiredFields) {
        if (!field.value.trim()) {
            isValid = false;
            field.classList.add('border-red-500');
            // Hapus kelas error setelah beberapa saat
            setTimeout(() => field.classList.remove('border-red-500'), 3000);
        }
    }
    
    return isValid;
}

function renderReservationList() {
    const container = document.getElementById('reservation-list');
    const statusFilter = filterStatusSelect.value;
    const searchQuery = searchReservationsInput.value.toLowerCase();
    const sortOption = sortBySelect.value;
    
    // Filter reservasi berdasarkan status dan pencarian
    let filteredReservations = reservations.filter(r => {
        const matchesStatus = statusFilter === 'all' || r.status === statusFilter;
        const matchesSearch = 
            r.patientName.toLowerCase().includes(searchQuery) ||
            r.bookerName.toLowerCase().includes(searchQuery) ||
            r.phone.includes(searchQuery) ||
            r.rme.toLowerCase().includes(searchQuery);
        
        return matchesStatus && matchesSearch;
    });
    
    // Urutkan reservasi
    filteredReservations.sort((a, b) => {
        switch(sortOption) {
            case 'timestamp-desc':
                return new Date(b.timestamp) - new Date(a.timestamp);
            case 'timestamp-asc':
                return new Date(a.timestamp) - new Date(b.timestamp);
            case 'name-asc':
                return a.patientName.localeCompare(b.patientName);
            case 'name-desc':
                return b.patientName.localeCompare(a.patientName);
            default:
                return 0;
        }
    });
    
    // Kosongkan container
    container.innerHTML = '';
    
    if (filteredReservations.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 mt-10">Tidak ada reservasi yang sesuai.</p>';
        return;
    }
    
    // Render setiap reservasi
    filteredReservations.forEach(reservation => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl p-4 shadow-md border border-pink-100';
        
        // Format tanggal dan waktu
        const bookingDate = new Date(reservation.bookingDate).toLocaleDateString('id-ID', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        // Tentukan kelas warna status
        let statusClass = '';
        switch(reservation.status) {
            case 'Dalam Antrian':
                statusClass = 'bg-blue-100 text-blue-800';
                break;
            case 'Sedang Treatment':
                statusClass = 'bg-yellow-100 text-yellow-800';
                break;
            case 'Selesai':
                statusClass = 'bg-green-100 text-green-800';
                break;
            default:
                statusClass = 'bg-gray-100 text-gray-800';
        }
        
        card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h3 class="font-bold text-lg text-pink-800">${reservation.patientName}</h3>
                    <p class="text-sm text-gray-600">${reservation.bookerName} â¢ ${reservation.phone}</p>
                </div>
                <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">${reservation.status}</span>
            </div>
            
            <div class="mb-3 text-sm">
                <p><span class="font-semibold">RME:</span> ${reservation.rme || '-'}</p>
                <p><span class="font-semibold">Treatment:</span> ${Array.isArray(reservation.treatments) ? reservation.treatments.join(', ') : reservation.treatments}</p>
                <p><span class="font-semibold">Jadwal:</span> ${bookingDate}, ${reservation.bookingTime}</p>
                ${reservation.hasComplaint === 'ya' && reservation.complaintText ? `<p><span class="font-semibold">Keluhan:</span> ${reservation.complaintText}</p>` : ''}
                ${reservation.therapist ? `<p><span class="font-semibold">Terapis:</span> ${reservation.therapist}</p>` : ''}
            </div>
            
            <div class="flex flex-wrap gap-2">
                ${reservation.status === 'Dalam Antrian' ? `
                    <button onclick="startTreatment('${reservation.id}')" class="px-3 py-1 bg-yellow-500 text-white rounded-lg text-sm font-semibold">Mulai Treatment</button>
                ` : ''}
                
                ${reservation.status === 'Sedang Treatment' ? `
                    <button onclick="showTherapistModal('${reservation.id}')" class="px-3 py-1 bg-green-600 text-white rounded-lg text-sm font-semibold">Selesaikan</button>
                ` : ''}
                
                <button onclick="editReservation('${reservation.id}')" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-sm font-semibold">Edit</button>
                <button onclick="cancelReservation('${reservation.id}')" class="px-3 py-1 bg-red-500 text-white rounded-lg text-sm font-semibold">Batal</button>
            </div>
        `;
        
        container.appendChild(card);
    });
}

function showTherapistModal(reservationId) {
    currentlyEditingReservationId = reservationId;
    document.getElementById('therapist-modal').classList.remove('hidden');
    
    // Reset form modal
    document.getElementById('therapist-name').value = '';
    document.getElementById('additional-treatment').value = '';
    document.getElementById('treatment-fee').value = '';
    document.getElementById('medical-temperature').value = '';
    document.getElementById('medical-weight').value = '';
    document.getElementById('medical-height').value = '';
    document.getElementById('medical-bmi').value = '';
    document.getElementById('medical-allergy').value = '';
    document.getElementById('medical-blood-pressure').value = '';
    document.getElementById('medical-notes').value = '';
}

function hideTherapistModal() {
    document.getElementById('therapist-modal').classList.add('hidden');
    currentlyEditingReservationId = null;
}

function calculateBMI() {
    const weight = parseFloat(medicalWeight.value);
    const height = parseFloat(medicalHeight.value) / 100; // Konversi cm ke m
    
    if (weight && height && height > 0) {
        const bmi = weight / (height * height);
        medicalBmi.value = bmi.toFixed(1);
    } else {
        medicalBmi.value = '';
    }
}

async function completeTreatment() {
    const therapistName = document.getElementById('therapist-name').value;
    
    if (!therapistName) {
        alert('Nama terapis harus diisi!');
        return;
    }
    
    showLoading();
    
    try {
        const medicalData = {
            therapist: therapistName,
            additionalTreatment: document.getElementById('additional-treatment').value,
            fee: document.getElementById('treatment-fee').value,
            temperature: document.getElementById('medical-temperature').value,
            weight: document.getElementById('medical-weight').value,
            height: document.getElementById('medical-height').value,
            bmi: document.getElementById('medical-bmi').value,
            allergy: document.getElementById('medical-allergy').value,
            bloodPressure: document.getElementById('medical-blood-pressure').value,
            medicalNotes: document.getElementById('medical-notes').value
        };
        
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'completeTreatment',
                reservationId: currentlyEditingReservationId,
                data: medicalData
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Refresh data dan tutup modal
            await fetchInitialData();
            hideTherapistModal();
            alert('Treatment berhasil diselesaikan!');
        } else {
            alert('Gagal menyelesaikan treatment: ' + (result.message || 'Terjadi kesalahan'));
        }
    } catch (error) {
        console.error('Error completing treatment:', error);
        alert('Terjadi kesalahan saat menyelesaikan treatment. Silakan coba lagi.');
    } finally {
        hideLoading();
    }
}

async function startTreatment(reservationId) {
    if (!confirm('Mulai treatment untuk pasien ini?')) return;
    
    showLoading();
    
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'updateStatus',
                reservationId: reservationId,
                status: 'Sedang Treatment'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            await fetchInitialData();
            alert('Status berhasil diubah menjadi "Sedang Treatment"');
        } else {
            alert('Gagal mengubah status: ' + (result.message || 'Terjadi kesalahan'));
        }
    } catch (error) {
        console.error('Error starting treatment:', error);
        alert('Terjadi kesalahan saat mengubah status. Silakan coba lagi.');
    } finally {
        hideLoading();
    }
}

async function cancelReservation(reservationId) {
    if (!confirm('Batalkan reservasi ini?')) return;
    
    showLoading();
    
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'updateStatus',
                reservationId: reservationId,
                status: 'Batal'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            await fetchInitialData();
            alert('Reservasi berhasil dibatalkan');
        } else {
            alert('Gagal membatalkan reservasi: ' + (result.message || 'Terjadi kesalahan'));
        }
    } catch (error) {
        console.error('Error canceling reservation:', error);
        alert('Terjadi kesalahan saat membatalkan reservasi. Silakan coba lagi.');
    } finally {
        hideLoading();
    }
}

function editReservation(reservationId) {
    // Cari reservasi berdasarkan ID
    const reservation = reservations.find(r => r.id === reservationId);
    if (!reservation) {
        alert('Reservasi tidak ditemukan!');
        return;
    }
    
    // Isi form dengan data reservasi
    document.getElementById('rme').value = reservation.rme || '';
    document.getElementById('booker-name').value = reservation.bookerName;
    document.getElementById('phone').value = reservation.phone;
    document.getElementById('instagram').value = reservation.instagram || '';
    document.getElementById('address').value = reservation.address || '';
    document.getElementById('patient-name').value = reservation.patientName;
    document.getElementById('dob').value = reservation.dob;
    calculateAge();
    
    // Set jenis kelamin
    const genderRadios = document.getElementsByName('gender');
    for (const radio of genderRadios) {
        radio.checked = (radio.value === reservation.gender);
    }
    
    // Set kategori
    const isOtherCategory = ![
        'Baby/Kid Spa', 'Ladies Spa', 'Mom/Bumil/Nifas Spa', 
        'Tindik dr Evoo', 'ANC/Senam', 'Umum', 'Partus/Melahirkan', 'Homecare'
    ].includes(reservation.category);
    
    if (isOtherCategory) {
        categorySelect.value = 'other';
        categoryOtherInput.value = reservation.category;
        categoryOtherInput.classList.remove('hidden');
    } else {
        categorySelect.value = reservation.category;
        categoryOtherInput.classList.add('hidden');
    }
    
    // Set treatment
    const treatmentsContainer = document.getElementById('treatments-container');
    treatmentsContainer.innerHTML = '';
    
    const treatmentValues = Array.isArray(reservation.treatments) ? 
        reservation.treatments : [reservation.treatments];
    
    treatmentValues.forEach((treatment, index) => {
        const div = document.createElement('div');
        div.innerHTML = `
            <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Treatment/Spa ${index + 1}</label>
            <input type="text" name="treatment" class="w-full p-3 rounded-lg form-input" value="${treatment}" ${index === 0 ? 'required' : ''}>
        `;
        treatmentsContainer.appendChild(div);
    });
    
    treatmentCounter = treatmentValues.length;
    
    // Set keluhan
    const hasComplaint = reservation.hasComplaint === 'ya';
    document.querySelector(`input[name="complaint_toggle"][value="${hasComplaint ? 'ya' : 'tidak'}"]`).checked = true;
    complaintText.value = reservation.complaintText || '';
    complaintText.classList.toggle('hidden', !hasComplaint);
    
    // Set tanggal dan waktu
    document.getElementById('booking-date').value = reservation.bookingDate;
    document.getElementById('booking-time').value = reservation.bookingTime;
    
    // Simpan ID reservasi yang sedang diedit
    currentlyEditingReservationId = reservationId;
    
    // Scroll ke form dan tampilkan halaman form
    showPage('page-form');
    window.scrollTo(0, 0);
    
    // Perbarui timeslots
    populateTimeSlots();
}

function showTicketModal(reservationId) {
    const reservation = reservations.find(r => r.id === reservationId);
    if (!reservation) return;
    
    // Isi data tiket
    document.getElementById('ticket-rme').textContent = reservation.rme || '-';
    document.getElementById('ticket-name').textContent = reservation.patientName;
    document.getElementById('ticket-treatment').textContent = Array.isArray(reservation.treatments) ? 
        reservation.treatments.join(', ') : reservation.treatments;
    
    const bookingDate = new Date(reservation.bookingDate).toLocaleDateString('id-ID', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    document.getElementById('ticket-schedule').textContent = `${bookingDate}, ${reservation.bookingTime}`;
    
    // Tampilkan data medis jika sudah ada
    const hasMedicalData = reservation.temperature || reservation.weight || reservation.height || 
                          reservation.allergy || reservation.bloodPressure || reservation.medicalNotes;
    
    if (hasMedicalData) {
        document.getElementById('ticket-medical-data').classList.remove('hidden');
        let medicalDetails = '';
        
        if (reservation.temperature) medicalDetails += `<p><strong>Suhu:</strong> ${reservation.temperature}Â°C</p>`;
        if (reservation.weight) medicalDetails += `<p><strong>Berat:</strong> ${reservation.weight} kg</p>`;
        if (reservation.height) medicalDetails += `<p><strong>Tinggi:</strong> ${reservation.height} cm</p>`;
        if (reservation.bmi) medicalDetails += `<p><strong>BMI:</strong> ${reservation.bmi}</p>`;
        if (reservation.allergy) medicalDetails += `<p><strong>Alergi:</strong> ${reservation.allergy}</p>`;
        if (reservation.bloodPressure) medicalDetails += `<p><strong>Tekanan Darah:</strong> ${reservation.bloodPressure}</p>`;
        if (reservation.medicalNotes) medicalDetails += `<p><strong>Catatan:</strong> ${reservation.medicalNotes}</p>`;
        
        document.getElementById('ticket-medical-details').innerHTML = medicalDetails;
    } else {
        document.getElementById('ticket-medical-data').classList.add('hidden');
    }
    
    // Hitung nomor antrian (berdasarkan jumlah reservasi dengan status "Dalam Antrian")
    const queueNumber = reservations.filter(r => 
        r.status === 'Dalam Antrian' || r.status === 'Sedang Treatment'
    ).length;
    document.getElementById('ticket-queue-number').textContent = `A${queueNumber.toString().padStart(3, '0')}`;
    
    // Tampilkan modal
    document.getElementById('ticket-modal').classList.remove('hidden');
}

function hideTicketModal() {
    document.getElementById('ticket-modal').classList.add('hidden');
}

function downloadTicket() {
    html2canvas(document.getElementById('ticket-content')).then(canvas => {
        const link = document.createElement('a');
        link.download = 'nomor-antrian.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    });
}

function printTicketPDF() {
    const { jsPDF } = window.jspdf;
    html2canvas(document.getElementById('ticket-content')).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a6'
        });
        
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save('nomor-antrian.pdf');
    });
}

function generateStats(period) {
    const now = new Date();
    let startDate, endDate, title;
    
    switch(period) {
        case 'today':
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            title = 'Hari Ini';
            break;
        case 'week':
            const dayOfWeek = now.getDay();
            const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diffToMonday);
            endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 7);
            title = 'Pekan Ini';
            break;
        case 'month':
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            title = 'Bulan Ini';
            break;
        default:
            return;
    }
    
    // Filter reservasi berdasarkan periode
    const periodReservations = reservations.filter(r => {
        const reservationDate = new Date(r.bookingDate);
        return reservationDate >= startDate && reservationDate < endDate && r.status !== 'Batal';
    });
    
    // Hitung statistik
    const totalReservations = periodReservations.length;
    const completed = periodReservations.filter(r => r.status === 'Selesai').length;
    const inQueue = periodReservations.filter(r => r.status === 'Dalam Antrian').length;
    const inTreatment = periodReservations.filter(r => r.status === 'Sedang Treatment').length;
    
    // Hitung pendapatan (jika ada data fee)
    const revenue = periodReservations
        .filter(r => r.status === 'Selesai' && r.fee)
        .reduce((sum, r) => sum + parseInt(r.fee || 0), 0);
    
    // Kategori treatment populer
    const categoryCounts = {};
    periodReservations.forEach(r => {
        if (r.category) {
            categoryCounts[r.category] = (categoryCounts[r.category] || 0) + 1;
        }
    });
    
    const popularCategories = Object.entries(categoryCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
    
    // Render statistik
    const statsContent = document.getElementById('stats-content');
    statsContent.innerHTML = `
        <h3 class="text-xl font-bold text-pink-800 mb-4">Statistik ${title}</h3>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-pink-50 rounded-xl p-4 text-center">
                <div class="text-3xl font-bold text-pink-700">${totalReservations}</div>
                <div class="text-sm text-pink-600">Total Reservasi</div>
            </div>
            <div class="bg-green-50 rounded-xl p-4 text-center">
                <div class="text-3xl font-bold text-green-700">${completed}</div>
                <div class="text-sm text-green-600">Selesai</div>
            </div>
            <div class="bg-blue-50 rounded-xl p-4 text-center">
                <div class="text-3xl font-bold text-blue-700">${inQueue}</div>
                <div class="text-sm text-blue-600">Dalam Antrian</div>
            </div>
            <div class="bg-yellow-50 rounded-xl p-4 text-center">
                <div class="text-3xl font-bold text-yellow-700">${inTreatment}</div>
                <div class="text-sm text-yellow-600">Sedang Treatment</div>
            </div>
        </div>
        
        ${revenue > 0 ? `
        <div class="bg-purple-50 rounded-xl p-4 mb-6">
            <div class="text-2xl font-bold text-purple-700 text-center">Rp ${revenue.toLocaleString('id-ID')}</div>
            <div class="text-sm text-purple-600 text-center">Total Pendapatan</div>
        </div>
        ` : ''}
        
        ${popularCategories.length > 0 ? `
        <div class="mb-6">
            <h4 class="font-bold text-lg text-pink-700 mb-3">Kategori Treatment Populer</h4>
            <div class="space-y-2">
                ${popularCategories.map(([category, count]) => `
                    <div class="flex justify-between items-center">
                        <span>${category}</span>
                        <span class="font-semibold">${count}</span>
                    </div>
                `).join('')}
            </div>
        </div>
        ` : ''}
        
        ${periodReservations.length > 0 ? `
        <div>
            <h4 class="font-bold text-lg text-pink-700 mb-3">Detail Reservasi</h4>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-pink-100">
                            <th class="p-2 text-left">Nama</th>
                            <th class="p-2 text-left">Treatment</th>
                            <th class="p-2 text-left">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${periodReservations.map(r => `
                            <tr class="border-b border-pink-100">
                                <td class="p-2">${r.patientName}</td>
                                <td class="p-2">${Array.isArray(r.treatments) ? r.treatments.join(', ') : r.treatments}</td>
                                <td class="p-2">
                                    <span class="px-2 py-1 rounded-full text-xs ${
                                        r.status === 'Selesai' ? 'bg-green-100 text-green-800' :
                                        r.status === 'Sedang Treatment' ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-blue-100 text-blue-800'
                                    }">${r.status}</span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
        ` : '<p class="text-center text-gray-500">Tidak ada data reservasi untuk periode ini.</p>'}
    `;
}

function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    
    // Judul
    pdf.setFontSize(18);
    pdf.setTextColor(64, 64, 64);
    pdf.text('Laporan Statistik Klinik', 105, 15, { align: 'center' });
    
    // Tanggal
    pdf.setFontSize(12);
    pdf.setTextColor(128, 128, 128);
    pdf.text(`Dibuat pada: ${new Date().toLocaleDateString('id-ID')}`, 105, 22, { align: 'center' });
    
    // Konten statistik
    const statsContent = document.getElementById('stats-content');
    const contentHtml = statsContent.innerHTML;
    
    // Sederhanakan HTML untuk konversi PDF (opsional - bisa menggunakan html2canvas juga)
    pdf.setFontSize(10);
    pdf.setTextColor(0, 0, 0);
    
    // Untuk demo, kita hanya menambahkan teks sederhana
    pdf.text('Laporan statistik lengkap hanya tersedia dalam tampilan aplikasi.', 20, 40);
    pdf.text('Gunakan fitur screenshot perangkat Anda untuk menyimpan laporan.', 20, 50);
    
    // Simpan PDF
    pdf.save('laporan-statistik.pdf');
}

// --- FUNGSI BANTUAN ---
function showLoading() {
    document.getElementById('loading-spinner').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loading-spinner').classList.add('hidden');
}

function setButtonLoading(button, isLoading) {
    if (isLoading) {
        button.classList.add('btn-loading');
        button.disabled = true;
        loadingButtons[button.id] = true;
    } else {
        button.classList.remove('btn-loading');
        button.disabled = false;
        delete loadingButtons[button.id];
    }
}

// Fungsi untuk memformat angka sebagai Rupiah
function formatRupiah(amount) {
    return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
    }).format(amount);
}

// Fungsi untuk mendapatkan nama hari dalam Bahasa Indonesia
function getIndonesianDayName(date) {
    const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    return days[date.getDay()];
}
</script>
</body>
</html>
