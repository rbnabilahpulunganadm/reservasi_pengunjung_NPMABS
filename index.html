<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservasi - Klinik Nabilah Pulungan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <!-- [BARU] Menambahkan Chart.js untuk grafik statistik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #FDF2F8; }
        .font-mplus { font-family: 'M PLUS Rounded 1c', sans-serif; }
        .main-container { max-width: 500px; margin: 0 auto; min-height: 100vh; background-color: white; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .navbar { box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item.active svg, .nav-item.active span { color: #DB2777; /* Pink-700 */ }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #FDF2F8; }
        ::-webkit-scrollbar-thumb { background: #F472B6; border-radius: 10px; }
        .page { display: none; }
        .page.active { display: block; }
        .form-input, .form-select, .form-textarea { border-width: 1px; border-color: #FBCFE8; transition: all 0.3s ease; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: #DB2777; box-shadow: 0 0 0 2px #FCE7F3; }
        .btn-primary { background-color: #EC4899; color: white; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #DB2777; }
        .btn-secondary { background-color: #FCE7F3; color: #DB2777; }
        .btn-loading { position: relative; color: transparent !important; }
        .btn-loading::after { content: ''; position: absolute; width: 20px; height: 20px; top: 50%; left: 50%; margin: -10px 0 0 -10px; border: 2px solid #ffffff; border-radius: 50%; border-top-color: transparent; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .stat-card { background-color: #FFF7FA; border: 1px solid #FBCFE8; }
    </style>
</head>
<body class="bg-pink-50">

<div id="app-container" class="main-container relative pb-20">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="hidden fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-pink-500"></div>
    </div>

    <!-- Modal Keamanan (Password) -->
    <div id="password-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center">
            <i class="fas fa-lock text-4xl text-yellow-500 mb-3"></i>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Akses Terbatas</h3>
            <p class="text-gray-600 mb-4">Silakan masukkan sandi untuk melanjutkan.</p>
            <input type="password" id="password-input" class="w-full p-3 text-center rounded-lg form-input text-lg tracking-widest" placeholder="******">
            <p id="password-error" class="hidden text-red-500 text-sm mt-2">Sandi salah. Coba lagi.</p>
            <div class="flex gap-3 mt-4">
                <button onclick="hidePasswordModal()" class="w-full py-2 rounded-lg btn-secondary font-semibold">Batal</button>
                <button onclick="checkPassword()" class="w-full py-2 rounded-lg btn-primary font-semibold">Masuk</button>
            </div>
        </div>
    </div>

    <!-- Modal Riwayat Pasien -->
    <div id="history-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-pink-800">Riwayat Kunjungan Pasien</h3>
                <button onclick="hideHistoryModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="history-content" class="flex-grow overflow-y-auto space-y-3 pr-2"></div>
        </div>
    </div>
    
    <!-- Modal Selesaikan Treatment -->
    <div id="therapist-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-pink-800 mb-4">Selesaikan Treatment</h3>
            <p class="text-gray-600 mb-4">Masukkan data terapis dan pemeriksaan medis.</p>
            <div class="space-y-4">
                <div>
                    <label for="therapist-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Terapis *</label>
                    <input type="text" id="therapist-name" class="w-full p-3 rounded-lg form-input" required>
                </div>
                <div>
                    <label for="additional-treatment" class="block text-sm font-medium text-gray-700 mb-1">Treatment Tambahan</label>
                    <input type="text" id="additional-treatment" class="w-full p-3 rounded-lg form-input">
                </div>
                <div>
                    <label for="treatment-fee" class="block text-sm font-medium text-gray-700 mb-1">Tarif Treatment (Rp)</label>
                    <input type="number" id="treatment-fee" class="w-full p-3 rounded-lg form-input">
                </div>
                <h4 class="font-bold text-lg text-pink-700 border-b-2 border-pink-200 pb-2 mt-2">Pemeriksaan Medis</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="medical-temperature" class="block text-sm font-medium text-gray-700 mb-1">Suhu (Â°C)</label>
                        <input type="number" id="medical-temperature" step="0.1" class="w-full p-3 rounded-lg form-input">
                    </div>
                    <div>
                        <label for="medical-weight" class="block text-sm font-medium text-gray-700 mb-1">Berat (kg)</label>
                        <input type="number" id="medical-weight" step="0.1" class="w-full p-3 rounded-lg form-input">
                    </div>
                    <div>
                        <label for="medical-height" class="block text-sm font-medium text-gray-700 mb-1">Tinggi (cm)</label>
                        <input type="number" id="medical-height" step="0.1" class="w-full p-3 rounded-lg form-input">
                    </div>
                    <div>
                        <label for="medical-bmi" class="block text-sm font-medium text-gray-700 mb-1">BMI</label>
                        <input type="text" id="medical-bmi" readonly class="w-full p-3 rounded-lg form-input bg-gray-100">
                    </div>
                </div>
                 <div>
                    <label for="medical-blood-pressure" class="block text-sm font-medium text-gray-700 mb-1">Tekanan Darah</label>
                    <input type="text" id="medical-blood-pressure" placeholder="120/80 mmHg" class="w-full p-3 rounded-lg form-input">
                </div>
                <div>
                    <label for="medical-allergy" class="block text-sm font-medium text-gray-700 mb-1">Riwayat Alergi</label>
                    <input type="text" id="medical-allergy" class="w-full p-3 rounded-lg form-input">
                </div>
                <div>
                    <label for="medical-notes" class="block text-sm font-medium text-gray-700 mb-1">Catatan Medis</label>
                    <textarea id="medical-notes" rows="2" class="w-full p-3 rounded-lg form-textarea"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="hideTherapistModal()" class="py-2 px-4 rounded-lg btn-secondary font-semibold">Batal</button>
                <button onclick="completeTreatment()" class="py-2 px-4 rounded-lg btn-primary font-semibold">Selesaikan</button>
            </div>
        </div>
    </div>

    <!-- Modal Tiket Antrian -->
    <div id="ticket-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-2xl font-bold text-center text-pink-800 mb-2 font-mplus">Reservasi Berhasil!</h3>
            <p class="text-center text-gray-500 mb-4">Silakan simpan nomor antrian ini.</p>
            <div id="ticket-content" class="border-2 border-dashed border-pink-300 rounded-xl p-4 mb-4 bg-white">
                <div class="text-center">
                    <h4 class="font-mplus text-pink-700 font-bold text-lg">Klinik Nabilah Pulungan</h4>
                    <p class="text-xs text-pink-500">Bukti Reservasi Treatment</p>
                </div>
                <p class="text-center text-sm text-gray-700 my-2">No. RME: <span id="ticket-rme" class="font-bold"></span></p>
                <div class="border-t border-b border-pink-200 py-2 my-2 text-sm space-y-1">
                    <p><strong>Nama:</strong> <span id="ticket-name"></span></p>
                    <p><strong>Treatment:</strong> <span id="ticket-treatment"></span></p>
                    <p><strong>Jadwal:</strong> <span id="ticket-schedule"></span></p>
                </div>
                <p class="text-center font-bold text-4xl text-pink-600 font-mplus mt-2" id="ticket-queue-number"></p>
                <p class="text-center text-xs text-gray-400 mt-2">Terima kasih atas kunjungan Anda!</p>
            </div>
            <div class="flex flex-col gap-3">
                <button onclick="downloadTicket()" class="w-full py-3 px-4 rounded-lg btn-primary font-semibold flex items-center justify-center gap-2"><i class="fas fa-download"></i> Unduh Nomor Antrian</button>
                <button onclick="hideTicketModal()" class="w-full py-3 px-4 rounded-lg btn-secondary font-semibold">Tutup</button>
            </div>
        </div>
    </div>

    <!-- PAGES -->
    <main class="p-4 sm:p-6">
        <!-- PAGE 1: FORM RESERVASI -->
        <div id="page-form" class="page active">
            <header class="text-center mb-6">
                <h1 class="text-3xl font-bold text-pink-800 font-mplus">Reservasi Treatment</h1>
                <p class="text-gray-500">Isi data untuk jadwal treatment Anda.</p>
            </header>
            
            <div class="mb-4">
                 <div class="relative">
                    <input type="text" id="search-customer" placeholder="Cari Pasien (Nama/HP/IG/RME)" class="w-full p-3 pl-10 rounded-lg form-input">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div id="search-results" class="hidden bg-white border border-pink-200 rounded-lg mt-1 max-h-40 overflow-y-auto"></div>
            </div>

            <form id="reservation-form" class="space-y-4" onsubmit="handleFormSubmit(event)">
                <h3 class="font-bold text-lg text-pink-700 border-b-2 border-pink-200 pb-2">Data Pemesan</h3>
                <input type="hidden" id="rme">
                <div>
                    <label for="booker-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Pemesan</label>
                    <input type="text" id="booker-name" class="w-full p-3 rounded-lg form-input" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">No. Telepon/WA</label>
                        <input type="tel" id="phone" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                    <div>
                        <label for="instagram" class="block text-sm font-medium text-gray-700 mb-1">Instagram</label>
                        <input type="text" id="instagram" class="w-full p-3 rounded-lg form-input">
                    </div>
                </div>
                <div>
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Alamat Domisili</label>
                    <textarea id="address" rows="2" class="w-full p-3 rounded-lg form-textarea"></textarea>
                </div>
                
                <div class="flex justify-between items-center border-b-2 border-pink-200 pt-4 pb-2">
                     <h3 class="font-bold text-lg text-pink-700">Data Pasien</h3>
                     <div id="history-button-container"></div>
                </div>

                <div>
                    <label for="patient-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Pasien</label>
                    <input type="text" id="patient-name" class="w-full p-3 rounded-lg form-input" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="dob" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Lahir</label>
                        <input type="date" id="dob" class="w-full p-3 rounded-lg form-input" required onchange="calculateAge()">
                    </div>
                    <div>
                        <label for="age" class="block text-sm font-medium text-gray-700 mb-1">Usia</label>
                        <input type="text" id="age" class="w-full p-3 rounded-lg form-input bg-pink-50" readonly>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kelamin</label>
                    <div class="flex gap-4">
                        <label class="flex items-center"><input type="radio" name="gender" value="Perempuan" class="mr-2 text-pink-500 focus:ring-pink-500" checked> Perempuan</label>
                        <label class="flex items-center"><input type="radio" name="gender" value="Laki-laki" class="mr-2 text-pink-500 focus:ring-pink-500"> Laki-laki</label>
                    </div>
                </div>

                <h3 class="font-bold text-lg text-pink-700 border-b-2 border-pink-200 pb-2 pt-4">Detail Treatment</h3>
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Kategori Treatment</label>
                    <select id="category" class="w-full p-3 rounded-lg form-select" onchange="handleCategoryChange()">
                        <option>Baby/Kid Spa</option><option>Ladies Spa</option><option>Mom/Bumil/Nifas Spa</option><option>Tindik dr Evoo</option><option>ANC/Senam</option><option>Umum</option><option>Partus/Melahirkan</option><option>Homecare</option><option value="other">Lainnya...</option>
                    </select>
                    <input type="text" id="category-other" class="hidden w-full p-3 mt-2 rounded-lg form-input" placeholder="Ketik kategori lainnya">
                </div>

                <div id="treatments-container" class="space-y-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Treatment/Spa</label>
                        <input type="text" name="treatment" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                </div>
                <button type="button" onclick="addTreatmentField()" class="text-sm text-pink-600 font-semibold hover:underline">+ Tambah Treatment</button>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ada Keluhan?</label>
                    <div class="flex gap-4">
                        <label class="flex items-center"><input type="radio" name="complaint_toggle" value="ya" class="mr-2 text-pink-500 focus:ring-pink-500" onchange="handleComplaintToggle()"> Ya</label>
                        <label class="flex items-center"><input type="radio" name="complaint_toggle" value="tidak" class="mr-2 text-pink-500 focus:ring-pink-500" checked onchange="handleComplaintToggle()"> Tidak</label>
                    </div>
                    <textarea id="complaint-text" rows="2" class="hidden w-full p-3 mt-2 rounded-lg form-textarea" placeholder="Sebutkan keluhan Anda"></textarea>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="booking-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Datang</label>
                        <input type="date" id="booking-date" class="w-full p-3 rounded-lg form-input" required onchange="populateTimeSlots()">
                    </div>
                    <div>
                        <label for="booking-time" class="block text-sm font-medium text-gray-700 mb-1">Jam</label>
                        <select id="booking-time" class="w-full p-3 rounded-lg form-select" required></select>
                    </div>
                </div>
                <button type="submit" class="w-full mt-6 py-4 rounded-xl btn-primary font-bold text-lg"><i class="fas fa-calendar-check mr-2"></i> Buat Reservasi</button>
            </form>
        </div>

        <!-- PAGE 2: DAFTAR RESERVASI -->
        <div id="page-list" class="page">
            <header class="mb-6">
                <h1 class="text-3xl font-bold text-pink-800 font-mplus">Daftar Reservasi</h1>
                <p class="text-gray-500 mt-1">Kelola semua jadwal treatment pasien.</p>
                <div class="flex flex-wrap gap-2 my-4">
                    <select id="filter-status" class="p-2 rounded-lg form-select flex-1 min-w-[120px]" onchange="renderReservationList()">
                        <option value="all">Semua Status</option><option value="Dalam Antrian">Dalam Antrian</option><option value="Sedang Treatment">Sedang Treatment</option><option value="Selesai">Selesai</option><option value="Batal">Batal</option>
                    </select>
                    <select id="sort-by" class="p-2 rounded-lg form-select flex-1 min-w-[120px]" onchange="renderReservationList()">
                        <option value="timestamp-desc">Terbaru</option><option value="timestamp-asc">Terlama</option><option value="name-asc">Nama A-Z</option><option value="name-desc">Nama Z-A</option>
                    </select>
                </div>
                <div class="relative">
                    <input type="text" id="search-reservations" placeholder="Cari di daftar reservasi..." class="w-full p-3 pl-10 rounded-lg form-input" oninput="renderReservationList()">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
            </header>
            <div id="reservation-list" class="space-y-4"></div>
        </div>

        <!-- PAGE 3: LAPORAN STATISTIK (REVISI) -->
        <div id="page-stats" class="page">
            <header class="mb-6">
                <h1 class="text-3xl font-bold text-pink-800 font-mplus">Laporan Cerdas</h1>
                <p class="text-gray-500">Analisis & pantau performa klinik Anda.</p>
            </header>
            <div class="flex justify-center gap-2 mb-6">
                <button onclick="generateStats('today')" class="stat-button flex-1 py-2 px-3 bg-pink-100 text-pink-700 rounded-lg font-semibold">Hari Ini</button>
                <button onclick="generateStats('week')" class="stat-button flex-1 py-2 px-3 bg-pink-100 text-pink-700 rounded-lg font-semibold">7 Hari</button>
                <button onclick="generateStats('month')" class="stat-button flex-1 py-2 px-3 bg-pink-100 text-pink-700 rounded-lg font-semibold">30 Hari</button>
            </div>
            <div id="stats-content" class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="stat-card p-4 rounded-xl text-center">
                        <div id="stats-total-reservations" class="text-3xl font-bold text-pink-700">0</div>
                        <div class="text-sm text-pink-600">Total Kunjungan</div>
                    </div>
                    <div class="stat-card p-4 rounded-xl text-center">
                        <div id="stats-total-revenue" class="text-3xl font-bold text-pink-700">0</div>
                        <div class="text-sm text-pink-600">Total Pendapatan</div>
                    </div>
                </div>
                <div class="stat-card p-4 rounded-xl">
                    <h4 class="font-bold text-lg text-pink-700 mb-3">Kategori Treatment Terpopuler</h4>
                    <canvas id="category-chart"></canvas>
                </div>
                <div class="stat-card p-4 rounded-xl">
                    <h4 class="font-bold text-lg text-pink-700 mb-3">Kunjungan Setiap Hari</h4>
                    <canvas id="daily-chart"></canvas>
                </div>
                <div class="stat-card p-4 rounded-xl bg-teal-50 border-teal-200">
                    <h4 class="font-bold text-lg text-teal-700 mb-2 flex items-center gap-2"><i class="fas fa-lightbulb"></i> Saran Pintar</h4>
                    <p id="smart-suggestion" class="text-teal-800 text-sm">Pilih periode laporan untuk melihat saran.</p>
                </div>
            </div>
        </div>
        
        <!-- PAGE 4: PANDUAN -->
        <div id="page-guide" class="page">
             <header class="mb-6">
                <h1 class="text-3xl font-bold text-pink-800 font-mplus">Panduan Aplikasi</h1>
                <p class="text-gray-500">Cara menggunakan aplikasi reservasi.</p>
            </header>
            <div class="space-y-6 text-gray-700">
                <div>
                    <h3 class="font-bold text-lg text-pink-600"><i class="fas fa-user-plus w-6"></i>Pasien Baru & RME Otomatis</h3>
                    <p class="mt-1 ml-6">Untuk pasien baru, cukup kosongi pencarian dan isi data seperti biasa. Sistem akan otomatis membuatkan Nomor Rekam Medis (RME) baru untuk pasien tersebut.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-pink-600"><i class="fas fa-search w-6"></i>Pasien Lama & Riwayat</h3>
                    <p class="mt-1 ml-6">Gunakan kolom 'Cari Pasien' untuk data pasien lama. Setelah dipilih, data akan terisi otomatis dan tombol 'Lihat Riwayat' akan muncul untuk melihat histori treatment sebelumnya.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-pink-600"><i class="fas fa-lock w-6"></i>Keamanan Akses</h3>
                    <p class="mt-1 ml-6">Tab 'Daftar' dan 'Laporan' dilindungi kata sandi. Masukkan sandi <strong class="font-mono">112211</strong> untuk mengakses halaman tersebut.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- BOTTOM NAVIGATION -->
    <nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-[500px] bg-white/80 backdrop-blur-sm border-t border-pink-100 flex justify-around navbar">
        <button onclick="showPage('page-form')" class="nav-item flex-1 py-3 text-center text-gray-500 hover:text-pink-600 active"><i class="fas fa-plus-circle text-2xl"></i><span class="block text-xs font-medium">Reservasi</span></button>
        <button onclick="showPage('page-list')" class="nav-item flex-1 py-3 text-center text-gray-500 hover:text-pink-600"><i class="fas fa-list-alt text-2xl"></i><span class="block text-xs font-medium">Daftar</span></button>
        <button onclick="showPage('page-stats')" class="nav-item flex-1 py-3 text-center text-gray-500 hover:text-pink-600"><i class="fas fa-chart-pie text-2xl"></i><span class="block text-xs font-medium">Laporan</span></button>
        <button onclick="showPage('page-guide')" class="nav-item flex-1 py-3 text-center text-gray-500 hover:text-pink-600"><i class="fas fa-book text-2xl"></i><span class="block text-xs font-medium">Panduan</span></button>
    </nav>
</div>

<script>
// --- KONFIGURASI ---
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzsX_LQbBOzVDtIHwL5LVzSQ2lAY9H5JyuwRtREhTOjcfUACeuvZw5zhmpuMCTc-Sn2aA/exec'; 

// --- STATE APLIKASI ---
let reservations = [];
let customers = []; 
let treatmentCounter = 1;
let currentlyEditingReservationId = null;
let isAuthenticated = false;
let pageToShowAfterAuth = '';
let selectedCustomerRME = null;
let categoryChartInstance = null;
let dailyChartInstance = null;

// --- FUNGSI UTAMA ---
document.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dob').max = today;
    document.getElementById('booking-date').min = today;
    document.getElementById('booking-date').value = today;
    
    showPage('page-form');
    fetchInitialData();
});

async function fetchInitialData() {
    showLoading();
    try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getData`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();

        if (data && data.reservations && data.customers) {
            reservations = data.reservations.map(r => ({
                ...r,
                bookingDate: r['Tgl Booking'] ? new Date(r['Tgl Booking']).toISOString().split('T')[0] : '',
            }));
            customers = data.customers;
        }
    } catch (error) {
        console.error("Gagal mengambil data:", error);
        alert("Tidak dapat memuat data dari server.");
    } finally {
        populateTimeSlots();
        renderReservationList();
        hideLoading();
    }
}

// --- FUNGSI KEAMANAN & NAVIGASI ---
function showPage(pageId, forceShow = false) {
    if (!forceShow && (pageId === 'page-list' || pageId === 'page-stats') && !isAuthenticated) {
        showPasswordModal(pageId);
        return;
    }
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    const navIndex = ['page-form', 'page-list', 'page-stats', 'page-guide'].indexOf(pageId);
    if(navIndex !== -1) document.querySelector(`.nav-item:nth-child(${navIndex + 1})`).classList.add('active');
}
function showPasswordModal(target) {
    pageToShowAfterAuth = target;
    document.getElementById('password-modal').classList.remove('hidden');
    document.getElementById('password-input').focus();
}
function hidePasswordModal() {
    document.getElementById('password-modal').classList.add('hidden');
    document.getElementById('password-input').value = '';
    document.getElementById('password-error').classList.add('hidden');
}
function checkPassword() {
    if (document.getElementById('password-input').value === '112211') {
        isAuthenticated = true;
        hidePasswordModal();
        showPage(pageToShowAfterAuth, true);
    } else {
        document.getElementById('password-error').classList.remove('hidden');
    }
}

// --- FUNGSI FORM DAN DATA PASIEN ---
function handleCustomerSearch() {
    const query = document.getElementById('search-customer').value.toLowerCase().trim();
    const resultsContainer = document.getElementById('search-results');
    if (!query) {
        resultsContainer.innerHTML = '';
        resultsContainer.classList.add('hidden');
        return;
    }
    const results = customers.filter(c => Object.values(c).some(val => String(val).toLowerCase().includes(query)));
    resultsContainer.innerHTML = '';
    if (results.length > 0) {
        results.forEach(c => {
            const item = document.createElement('div');
            item.className = 'p-3 border-b border-pink-100 hover:bg-pink-50 cursor-pointer';
            item.innerHTML = `<div class="font-semibold">${c['Nama Pasien']}</div><div class="text-sm text-gray-600">${c['Telepon']} | RME: ${c.RME || '-'}</div>`;
            item.onclick = () => { fillCustomerData(c); resultsContainer.classList.add('hidden'); };
            resultsContainer.appendChild(item);
        });
    } else {
        resultsContainer.innerHTML = '<div class="p-3 text-gray-500 text-center">Tidak ditemukan pasien</div>';
    }
    resultsContainer.classList.remove('hidden');
}

function fillCustomerData(customer) {
    document.getElementById('rme').value = customer.RME || '';
    document.getElementById('booker-name').value = customer['Nama Pemesan'];
    document.getElementById('phone').value = customer.Telepon;
    document.getElementById('instagram').value = customer.Instagram || '';
    document.getElementById('address').value = customer.Alamat || '';
    document.getElementById('patient-name').value = customer['Nama Pasien'];
    const dob = customer['Tgl Lahir'] ? new Date(customer['Tgl Lahir']).toISOString().split('T')[0] : '';
    document.getElementById('dob').value = dob;
    document.querySelector(`input[name="gender"][value="${customer.Gender}"]`).checked = true;
    calculateAge();
    selectedCustomerRME = customer.RME;
    document.getElementById('history-button-container').innerHTML = `<button type="button" onclick="fetchAndShowHistory()" class="text-sm py-1 px-3 rounded-lg bg-pink-100 text-pink-700 font-semibold hover:bg-pink-200">Lihat Riwayat</button>`;
}

async function fetchAndShowHistory() {
    if (!selectedCustomerRME) return;
    showLoading();
    try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getPatientHistory&rme=${selectedCustomerRME}`);
        const historyData = await response.json();
        const container = document.getElementById('history-content');
        container.innerHTML = ''; 
        if (!historyData || historyData.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center">Tidak ada riwayat.</p>';
        } else {
            historyData
                .sort((a,b) => new Date(b['Tgl Booking']) - new Date(a['Tgl Booking']))
                .forEach(v => {
                    const el = document.createElement('div');
                    el.className = 'p-3 border rounded-lg bg-pink-50 text-sm';
                    el.innerHTML = `<p class="font-bold text-pink-700">${new Date(v['Tgl Booking']).toLocaleDateString('id-ID', {day:'2-digit', month:'long', year:'numeric'})}</p>
                                    <p><strong>Treatment:</strong> ${v.Treatments || '-'}</p>
                                    ${v['Detail Keluhan'] ? `<p><strong>Keluhan:</strong> ${v['Detail Keluhan']}</p>` : ''}
                                    ${v.Terapis ? `<p><strong>Terapis:</strong> ${v.Terapis}</p>` : ''}
                                    ${v['Catatan Medis'] ? `<p><strong>Catatan:</strong> ${v['Catatan Medis']}</p>` : ''}`;
                    container.appendChild(el);
            });
        }
        showHistoryModal();
    } catch (e) {
        alert("Gagal memuat riwayat pasien.");
    } finally {
        hideLoading();
    }
}

// [REVISI] Perhitungan usia lebih akurat
function calculateAge() {
    const dobInput = document.getElementById('dob');
    if (!dobInput.value) return;

    const dob = new Date(dobInput.value);
    const today = new Date();
    
    let years = today.getFullYear() - dob.getFullYear();
    let months = today.getMonth() - dob.getMonth();
    let days = today.getDate() - dob.getDate();

    if (days < 0) {
        months--;
        days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
    }
    if (months < 0) {
        years--;
        months += 12;
    }

    let weeks = Math.floor(days / 7);
    days = days % 7;

    let ageString = "";
    if (years > 0) ageString = `${years} Thn, ${months} Bln, ${days} Hari`;
    else if (months > 0) ageString = `${months} Bln, ${weeks} Mgg, ${days} Hari`;
    else if (weeks > 0) ageString = `${weeks} Mgg, ${days} Hari`;
    else ageString = `${days} Hari`;
    
    document.getElementById('age').value = ageString;
}

function populateTimeSlots() {
    const timeSelect = document.getElementById('booking-time');
    const dateInput = document.getElementById('booking-date');
    timeSelect.innerHTML = '';
    if (!dateInput.value) return;
    
    const maxQuota = 2;
    for (let h = 8; h <= 17; h++) {
        const time = `${String(h).padStart(2, '0')}:00`;
        const reserved = reservations.filter(r => r.bookingDate === dateInput.value && r.bookingTime === time && r.Status !== 'Batal').length;
        const available = maxQuota - reserved;
        if (available > 0) {
            timeSelect.innerHTML += `<option value="${time}">${time} (${available} slot)</option>`;
        }
    }
    if (timeSelect.options.length === 0) {
        timeSelect.innerHTML = '<option disabled>Penuh</option>';
    }
}

async function handleFormSubmit(e) {
    e.preventDefault();
    const submitButton = e.target.querySelector('button[type="submit"]');
    submitButton.classList.add('btn-loading');
    submitButton.disabled = true;

    try {
        const formData = {
            rme: document.getElementById('rme').value, // Bisa kosong untuk pasien baru
            bookerName: document.getElementById('booker-name').value,
            phone: document.getElementById('phone').value,
            instagram: document.getElementById('instagram').value,
            address: document.getElementById('address').value,
            patientName: document.getElementById('patient-name').value,
            dob: document.getElementById('dob').value,
            age: document.getElementById('age').value,
            gender: document.querySelector('input[name="gender"]:checked').value,
            category: document.getElementById('category').value === 'other' ? document.getElementById('category-other').value : document.getElementById('category').value,
            treatments: Array.from(document.querySelectorAll('input[name="treatment"]')).map(input => input.value).filter(Boolean).join(', '),
            hasComplaint: document.querySelector('input[name="complaint_toggle"]:checked').value,
            complaintText: document.getElementById('complaint-text').value,
            bookingDate: document.getElementById('booking-date').value,
            bookingTime: document.getElementById('booking-time').value
        };
        
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'createReservation', data: formData })
        });
        const result = await response.json();
        
        if (result.success) {
            await fetchInitialData(); // Ambil data terbaru, termasuk RME baru jika ada
            showTicketModal(result.reservationId, result.newRME || formData.rme);
            document.getElementById('reservation-form').reset();
            document.getElementById('history-button-container').innerHTML = '';
            calculateAge(); // Reset age field
        } else {
            throw new Error(result.message || 'Gagal membuat reservasi');
        }
    } catch (error) {
        alert('Terjadi kesalahan: ' + error.message);
    } finally {
        submitButton.classList.remove('btn-loading');
        submitButton.disabled = false;
    }
}

// --- FUNGSI MANAJEMEN RESERVASI ---
function renderReservationList() {
    const container = document.getElementById('reservation-list');
    const statusFilter = document.getElementById('filter-status').value;
    const sortOption = document.getElementById('sort-by').value;
    const searchQuery = document.getElementById('search-reservations').value.toLowerCase();

    let filtered = reservations.filter(r => 
        (statusFilter === 'all' || r.Status === statusFilter) &&
        (r['Nama Pasien'].toLowerCase().includes(searchQuery) || (r.RME || '').includes(searchQuery))
    );
    
    filtered.sort((a, b) => {
        if (sortOption === 'timestamp-desc') return new Date(b.Timestamp) - new Date(a.Timestamp);
        if (sortOption === 'timestamp-asc') return new Date(a.Timestamp) - new Date(b.Timestamp);
        if (sortOption === 'name-asc') return a['Nama Pasien'].localeCompare(b['Nama Pasien']);
        if (sortOption === 'name-desc') return b['Nama Pasien'].localeCompare(a['Nama Pasien']);
        return 0;
    });

    container.innerHTML = filtered.length === 0 ? '<p class="text-center text-gray-500 mt-10">Tidak ada reservasi.</p>' : filtered.map(r => {
        let statusClass = {'Dalam Antrian':'bg-blue-100 text-blue-800','Sedang Treatment':'bg-yellow-100 text-yellow-800','Selesai':'bg-green-100 text-green-800','Batal':'bg-red-100 text-red-800'}[r.Status] || 'bg-gray-100 text-gray-800';
        return `<div class="bg-white rounded-xl p-4 shadow-md border border-pink-100">
            <div class="flex justify-between items-start mb-2">
                <div><h3 class="font-bold text-lg text-pink-800">${r['Nama Pasien']}</h3><p class="text-sm text-gray-600">${r['Nama Pemesan']} â¢ ${r.Telepon}</p></div>
                <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">${r.Status}</span>
            </div>
            <div class="mb-3 text-sm"><p><strong>RME:</strong> ${r.RME||'-'}</p><p><strong>Jadwal:</strong> ${new Date(r.bookingDate).toLocaleDateString('id-ID',{weekday:'long',day:'numeric',month:'long'})}, ${r['Jam Booking']}</p></div>
            <div class="flex flex-wrap gap-2">
                ${r.Status === 'Dalam Antrian' ? `<button onclick="startTreatment('${r.ID}')" class="px-3 py-1 bg-yellow-500 text-white rounded-lg text-sm font-semibold">Mulai</button>` : ''}
                ${r.Status === 'Sedang Treatment' ? `<button onclick="showTherapistModal('${r.ID}')" class="px-3 py-1 bg-green-600 text-white rounded-lg text-sm font-semibold">Selesaikan</button>` : ''}
                ${r.Status !== 'Batal' && r.Status !== 'Selesai' ? `<button onclick="cancelReservation('${r.ID}')" class="px-3 py-1 bg-red-500 text-white rounded-lg text-sm font-semibold">Batal</button>` : ''}
            </div>
        </div>`;
    }).join('');
}

async function updateReservationStatus(id, status, data = null) {
    showLoading();
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', id, status, data }) });
        const result = await response.json();
        if (result.success) {
            await fetchInitialData();
            alert(`Status berhasil diubah.`);
        } else { throw new Error(result.message); }
    } catch (e) { alert('Gagal mengubah status: ' + e.message); } 
    finally { hideLoading(); }
}
function startTreatment(id) { if (confirm('Mulai treatment?')) updateReservationStatus(id, 'Sedang Treatment'); }
function cancelReservation(id) { if (confirm('Batalkan reservasi ini?')) updateReservationStatus(id, 'Batal'); }
function showTherapistModal(id) {
    currentlyEditingReservationId = id;
    document.getElementById('therapist-modal').classList.remove('hidden');
    document.getElementById('therapist-modal').querySelector('form')?.reset(); // Reset if it's a form
}
function hideTherapistModal() { document.getElementById('therapist-modal').classList.add('hidden'); }
async function completeTreatment() {
    const therapistName = document.getElementById('therapist-name').value;
    if (!therapistName) { alert('Nama terapis harus diisi.'); return; }
    const medicalData = {
        therapist: therapistName,
        additionalTreatment: document.getElementById('additional-treatment').value,
        fee: document.getElementById('treatment-fee').value,
        temperature: document.getElementById('medical-temperature').value,
        weight: document.getElementById('medical-weight').value,
        height: document.getElementById('medical-height').value,
        bmi: document.getElementById('medical-bmi').value,
        allergy: document.getElementById('medical-allergy').value,
        bloodPressure: document.getElementById('medical-blood-pressure').value,
        medicalNotes: document.getElementById('medical-notes').value
    };
    await updateReservationStatus(currentlyEditingReservationId, 'Selesai', medicalData);
    hideTherapistModal();
}
function calculateBMI() {
    const w = parseFloat(document.getElementById('medical-weight').value);
    const h = parseFloat(document.getElementById('medical-height').value) / 100;
    document.getElementById('medical-bmi').value = (w && h) ? (w / (h * h)).toFixed(1) : '';
}

// --- FUNGSI TIKET ---
function showTicketModal(reservationId, rme) {
    const r = reservations.find(res => res.ID === reservationId);
    if (!r) return;
    document.getElementById('ticket-rme').textContent = rme || '-';
    document.getElementById('ticket-name').textContent = r['Nama Pasien'];
    document.getElementById('ticket-treatment').textContent = r.Treatments;
    document.getElementById('ticket-schedule').textContent = `${new Date(r.bookingDate).toLocaleDateString('id-ID')}, ${r['Jam Booking']}`;
    const queueNumber = reservations.filter(res => res.bookingDate === r.bookingDate && res.Status === 'Dalam Antrian').length;
    document.getElementById('ticket-queue-number').textContent = `A${String(queueNumber).padStart(2, '0')}`;
    document.getElementById('ticket-modal').classList.remove('hidden');
}
function hideTicketModal() { document.getElementById('ticket-modal').classList.add('hidden'); }
function downloadTicket() { html2canvas(document.getElementById('ticket-content')).then(c => { const a = document.createElement('a'); a.download = 'nomor-antrian.png'; a.href = c.toDataURL('image/png'); a.click(); }); }


// --- [REVISI] FUNGSI LAPORAN STATISTIK ---
function generateStats(period) {
    const now = new Date();
    let startDate = new Date();
    startDate.setHours(0, 0, 0, 0);

    if (period === 'today') {
        // defaults to today
    } else if (period === 'week') {
        startDate.setDate(now.getDate() - 6);
    } else if (period === 'month') {
        startDate.setDate(now.getDate() - 29);
    }

    const filtered = reservations.filter(r => {
        const resDate = new Date(r.bookingDate);
        return resDate >= startDate && resDate <= now && r.Status !== 'Batal';
    });

    // Hitung KPI
    const totalReservations = filtered.length;
    const totalRevenue = filtered.reduce((sum, r) => sum + (parseInt(r.Tarif, 10) || 0), 0);
    document.getElementById('stats-total-reservations').textContent = totalReservations;
    document.getElementById('stats-total-revenue').textContent = `Rp${(totalRevenue/1000).toFixed(0)}k`;

    // Data untuk Chart Kategori
    const categoryCounts = filtered.reduce((acc, r) => {
        acc[r.Kategori] = (acc[r.Kategori] || 0) + 1;
        return acc;
    }, {});
    const sortedCategories = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
    updateChart('category-chart', categoryChartInstance, 'doughnut', sortedCategories.map(c => c[0]), sortedCategories.map(c => c[1]), 'Kategori Treatment');

    // Data untuk Chart Harian
    const dailyCounts = {};
    for (let i = 0; i < (period === 'today' ? 1 : period === 'week' ? 7 : 30); i++) {
        const d = new Date(startDate);
        d.setDate(startDate.getDate() + i);
        dailyCounts[d.toISOString().split('T')[0]] = 0;
    }
    filtered.forEach(r => { dailyCounts[r.bookingDate] = (dailyCounts[r.bookingDate] || 0) + 1; });
    const dailyLabels = Object.keys(dailyCounts).map(d => new Date(d).toLocaleDateString('id-ID', {weekday:'short', day:'2-digit'}));
    updateChart('daily-chart', dailyChartInstance, 'bar', dailyLabels, Object.values(dailyCounts), 'Total Kunjungan');
    
    // Saran Pintar
    const topCategory = sortedCategories.length > 0 ? sortedCategories[0][0] : null;
    let suggestion = "Data belum cukup untuk memberikan saran.";
    if (totalReservations > 5 && topCategory) {
        suggestion = `<strong>${topCategory}</strong> sedang populer! Pertimbangkan untuk membuat paket promo atau menonjolkan layanan ini di media sosial untuk menarik lebih banyak pelanggan.`;
    } else if (totalReservations <= 2) {
        suggestion = "Kunjungan terlihat sepi. Coba tingkatkan promosi di media sosial atau tawarkan diskon khusus untuk meningkatkan jumlah reservasi.";
    }
    document.getElementById('smart-suggestion').innerHTML = suggestion;
}

function updateChart(canvasId, chartInstance, type, labels, data, label) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (chartInstance) {
        chartInstance.destroy();
    }
    
    // Simpan instance chart yang baru dibuat
    if (canvasId === 'category-chart') {
        categoryChartInstance = new Chart(ctx, chartConfig(type, labels, data, label));
    } else if (canvasId === 'daily-chart') {
        dailyChartInstance = new Chart(ctx, chartConfig(type, labels, data, label));
    }
}

function chartConfig(type, labels, data, label) {
    const chartColors = {
        'doughnut': ['#EC4899', '#F472B6', '#F9A8D4', '#FBCFE8', '#FCE7F3'],
        'bar': '#EC4899'
    };
    return {
        type: type,
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                backgroundColor: chartColors[type],
                borderColor: '#ffffff',
                borderWidth: type === 'doughnut' ? 2 : 0,
                borderRadius: type === 'bar' ? 5 : 0,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: type === 'doughnut' } },
            scales: { y: { beginAtZero: true, display: type === 'bar' } }
        }
    };
}


// --- FUNGSI BANTUAN ---
function showLoading() { document.getElementById('loading-spinner').classList.remove('hidden'); }
function hideLoading() { document.getElementById('loading-spinner').classList.add('hidden'); }
function showHistoryModal() { document.getElementById('history-modal').classList.remove('hidden'); }
function hideHistoryModal() { document.getElementById('history-modal').classList.add('hidden'); }
function handleCategoryChange() { document.getElementById('category-other').classList.toggle('hidden', document.getElementById('category').value !== 'other'); }
function handleComplaintToggle() { document.getElementById('complaint-text').classList.toggle('hidden', document.querySelector('input[name="complaint_toggle"]:checked').value !== 'ya'); }
function addTreatmentField() { treatmentCounter++; const div = document.createElement('div'); div.innerHTML = `<label class="block text-sm font-medium text-gray-700 mb-1">Treatment ${treatmentCounter}</label><input type="text" name="treatment" class="w-full p-3 rounded-lg form-input">`; document.getElementById('treatments-container').appendChild(div); }
</script>
</body>
</html>

